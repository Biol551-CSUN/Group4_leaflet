---
title: "Group 4: Leaflet "
author: "Caroline S."
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---
# Introduction

### Leaflet package:
Allows you to create interactive maps using geographical data. You can add markers, lines, and polygons to your map, and customize them with various colors, sizes, and labels. You can also add various types of basemaps, such as satellite imagery or street maps, and control the zoom level and center of your map. Leaflet supports a variety of coordinate systems and projection formats, so you can easily work with data from different sources. Overall, it's a great tool for visualizing geographical data and exploring patterns and trends in your data. 

[Click here](https://rstudio.github.io/leaflet/) to learn more about this package.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "../output/")
```


```{r}
# Libraries ---------------------------------
#install.packages("leaflet.extras")
#install.packages("ggthemes")
library(leaflet) # Leaflet package for creating interactive maps
library(dplyr)   # Dplyr package for data manipulation
library(maps)    # To create the US map
library(RColorBrewer) #To create a color palette
library(leaflet.extras)
library(shiny)
library(ggthemes)
library(purrr)
library(tidyverse)
library(sf)
library(leaflet.extras)
library(shiny)
```

# Data
  We used the TidyTuesday "Bird FeederWatch" data for our project.  
  
  More specifically, we focused on the following columns to create an interactive map showing various bird data by state: 

  - latitude  
  - longitude  
  - subnational1_code   
  - Month  
  - species_code  
  - how_many  
  - day1_am  
  - day1_pm  
  - day2_am  
  - day2_pm  

**latitude** / **longitude**: Plot the bird sightings on a map  
**subnational1_code**: Group the sightings by state  
**Month**: Categorize the sightings by season  
**species_code** / **how_many**: Identify and count the number of birds sighted  
**day1_am** / **day1_pm** / **day2_am** / **day2_pm**: Calculate the total number of individuals seen during am or pm time  
  
 [Click here](https://github.com/rfordatascience/tidytuesday/blob/master/data/2023/2023-01-10/readme.md) to access and learn more about this data.

```{r}
# Load BirdFeeder Data ---------------------------------

# Load the bird feeder data from tidy Tuesday 
# Read the data directly from GitHub using readr::read_csv()

feederwatch <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-01-10/PFW_2021_public.csv')

site_data <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-01-10/PFW_count_site_data_public_2021.csv')


```



```{r}
# Functions ---------------------------------
#Notes:
        # "how_many" column:	Maximum number of individuals seen at one time during observation period
        # I created a new column named "total_birds" = sum(how_many) aka what is the sum of max number. We might not need this.



# Subset the data to only include relevant columns
feederwatch_sub <- feederwatch %>% select(subnational1_code, species_code, Month, day1_am, day1_pm, day2_am, day2_pm, how_many, latitude, longitude)

# rename the Month column numbers to actual month names
rename_months <- function(month_number) {
  months <- c("January", "February", "March", "April", "May", "June", "July",
              "August", "September", "October", "November", "December")
  return(months[month_number])
}
Month <- rename_months(feederwatch$Month)

# Apply month name change to dataset
feederwatch_sub <- feederwatch_sub %>%
  mutate(month = rename_months(Month))


# Create a function to categorize the birds based on season
categorize_season <- function(month) {
  if (month %in% c("March", "April", "May")) {
    "Spring"
  } else if (month %in% c("June", "July", "August")) {
    "Summer"
  } else if (month %in% c("September", "October", "November")) {
    "Fall"
  } else if (month %in% c("December", "January", "February")) {
    "Winter"
  } else {
    "Year-round"
  }
}


# Categorize the birds based on season
feederwatch_sub <- feederwatch_sub %>%
  mutate(season = map_chr(month, categorize_season))



# Calculate the total of individuals seen during am or pm time
feederwatch_sub <- feederwatch_sub %>%
  mutate(total_am = (day1_am + day2_am),
         total_pm = (day1_pm + day2_pm))


# Group and summarize the data by state, species, and season/month
feederwatch_state <- feederwatch_sub %>%
  group_by(subnational1_code, species_code, season, month) %>%
  reframe(total_birds = sum(how_many),
            total_am = sum(total_am),
            total_pm = sum(total_pm),
            lat = mean(latitude),
            long = mean(longitude)) 



```





```{r}
#CODE IN PROGRESS---------------------------------------------------------------

#map <- leaflet(feederwatch_state) %>% #Create a leaflet map with feederwatch_state data
#  addProviderTiles(tiles) %>% #use some type of tiles for base map
  
# The first function I'm using for our project: addMeasure() ---------------------------

#  addMarkers(...) %>%
   
#  addMeasure(primaryLengthUnit = "meters", secondaryAreaUnit = FALSE) %>%  # Add a measure control to the map. 
 
  #side notes for parameters:
  # setting the length in meters for now
  # I think miles will also work well for this and maybe acres for secondary instead of FALSE?
  #primaryLengthUnit: units used to display length results. 
      #Valid values are "feet", "meters", "miles", and "kilometers".
  #secondaryAreaUnit: units used to display area results. 
      #secondaryAreaUnit is optional. 
      #Valid values are "acres", "hectares", "sqmeters", and "sqmiles".


# The second function I'm using for our project: addSearchOSM() ---------------------------

#  addSearchOSM() %>% # Add search functionality
#  addPolygons(data = us_states, ...) %>%
#  addLegend(...)
  

```




```{r}

# create a reactive data frame that filters the original data based on the user's input
filtered_data <- reactive({
  if (input$filter_type == "species") {
    feederwatch_state %>% filter(species_code == input$filter_species)
  } else if (input$filter_type == "season") {
    feederwatch_state %>% filter(season == input$filter_season)
  } else if (input$filter_type == "month") {
    feederwatch_state %>% filter(month == input$filter_month)
  } else {
    feederwatch_state %>% filter(total_am > 0 & total_pm > 0)
  }
})



# create an interactive map
my_map <- leaflet(feederwatch_state) %>%
  addTiles() %>%
  addProviderTiles("Esri.WorldImagery") %>%
  setView(lng = -95.7129, lat = 37.0902, zoom = 4)


# create input controls for filtering
filter_controls <- list(
  selectInput(inputId = "filter_type",
              label = "Filter by:",
              choices = c("species", "season", "month", "time"),
              selected = "species"),
  textInput(inputId = "filter_species",
            label = "Enter a species name:"),
  selectInput(inputId = "filter_season",
              label = "Select a season:",
              choices = c("All", unique(feederwatch_state$season)),
              selected = "All"),
  selectInput(inputId = "filter_month",
              label = "Select a month:",
              choices = c("All", unique(feederwatch_state$month)),
              selected = "All"),
  checkboxInput(inputId = "filter_am",
                label = "Show AM data",
                value = TRUE),
  checkboxInput(inputId = "filter_pm",
                label = "Show PM data",
                value = TRUE)
)

# create filter button
filter_button <- actionButton(inputId = "filter_button",
                              label = "Apply filters")


# apply filters on button press
observeEvent(input$filter_button, {
  filtered_data <- filtered_data() %>%
    filter(season == input$filter_season,
           month == input$filter_month,
           total_am > 0 | input$filter_am,
           total_pm > 0 | input$filter_pm,
           species_code == input$filter_species)
  
  # update the map with filtered data
  my_map %>% 
    clearMarkers() %>%
    addCircleMarkers(data = filtered_data(), 
                     lat = ~latitude, 
                     lng = ~longitude, 
                     radius = ~total_birds/10, 
                     color = "blue", 
                     stroke = FALSE, 
                     fillOpacity = 0.8) %>%
    addLegend(position = "bottomright",
              pal = colorNumeric(palette = "Blues", domain = filtered_data()$total_birds),
              values = filtered_data()$total_birds,
              title = "Total Birds",
              opacity = 1)
})

  
# add search control and filter controls to map
my_map %>% 
  addSearchOSM() %>%
  addLayersControl(overlayGroups = list("Filtered Data" = filtered_data),
                   baseGroups = list("Original Data" = feederwatch_state),
                   options = layersControlOptions( filter_controls,collapsed = TRUE),
                   position = "topright") %>%
  addControl(
    filter_controls,
    tags$br(),
    filter_button,
    position = "topleft"
  )



```

