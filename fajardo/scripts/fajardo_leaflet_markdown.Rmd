---
title: "fajardo_leaflet_markdown"
author: "Cindy Fajardo"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "../Output/")
```

# Cites used
[Leaflet Source](https://rstudio.github.io/leaflet/map_widget.html)
This is a very good source to use to help you work your way through the leaflet package step by step. Each chapter will help you create layer by layer to make the map you are working with interactive with a variety of tools you can use.

# Libraries
```{r, Libraries}
library(tidyverse)
library(here)
library(leaflet)
library(sp)
library(rgeos)
library(readr)
```


# Read in Data
```{r, read in data}
feederwatch <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-01-10/PFW_2021_public.csv')

site_data <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-01-10/PFW_count_site_data_public_2021.csv')

SpeciesCode <- read_csv(here("fajardo","data","SpeciesCode.csv")) # This CSV file was downloaded from Project FeederWatch Data Dictionary found here (https://drive.google.com/file/d/1kHmx2XhA2MJtEyTNMpwqTQEnoa9M7Il2/view)
```

# Cites used
[Leaflet Source](https://rstudio.github.io/leaflet/map_widget.html)
This is a very good source to use to help you work your way through the leaflet package

# Basic leaflet commands to learn
In this section we will create a very simple map to help visualize what leaflet does. The functions that are used are leaflet(), addTiles(), and addMarkers().
```{r, Practice}
m <- leaflet() %>% #step 1. Create a map widget by calling leaflet()
  addTiles() %>%  # Add default OpenStreetMap map tiles, Step 2. Add layers (i.e., features) to the map by using layer functions (e.g. addTiles, addMarkers, addPolygons) to modify the map widget
  addMarkers(lng=174.768, lat=-36.852, popup="The birthplace of R") # Repeat step 2 as desired. When using markers you must must use longitude and latitude in order for the markers to be placed on the map.
m  # Print the map

```


# The Formula Interface
The arguments of all layer functions can take normal R objects, such as a numeric vector for the lat argument, or a character vector of colors for the color argument. They can also take a one-sided formula, in which case the formula will be evaluated using the data argument as the environment. For example, ~ x means the variable x in the data object, and you can write arbitrary expressions on the right-hand side, e.g., ~ sqrt(x + 1)
```{r}
m = leaflet() %>% addTiles()
df = data.frame(
  lat = rnorm(100),
  lng = rnorm(100),
  size = runif(100, 5, 20),
  color = sample(colors(), 100)
)
m = leaflet(df) %>% addTiles()
m %>% addCircleMarkers(radius = ~size, color = ~color, fill = FALSE)
m %>% addCircleMarkers(radius = runif(100, 4, 10), color = c('red'))
```


# Data Wrangling
In order to create our final map, we first needed to wrangle our data. We did a full join of feeder watch data and site data. We then did a full join of the new fully joined data named **birds_joined** with the species code data and selected columns loc_id, latitude, longtitude, subnational1_code, Month, Day, Year, species_cide, how_many, sci_name, order, family.
```{r}
feed_site <- full_join(feederwatch, site_data)
birds_joined <- full_join(feed_site, SpeciesCode) %>% 
  select(loc_id, latitude, longitude, subnational1_code, Month, Day, Year, species_code, how_many, sci_name, order, family)
birds_joined$date <- paste(birds_joined$Month, birds_joined$Day, birds_joined$Year, sep = "/") # the paste function is an R based command that will merge columns together and you can separate the values with a character, like "\", sourced from (https://datasharkie.com/how-to-merge-two-columns-in-r/) 
```

# Working with Cluster Markers and adding buttons.
When adding a large amounts of markers on your map, you can cluster them together using Leaflet.markercluster plug-in. To eneable the plug-in, you can use options like **clusterOptions**. The map becomes interactive, zooming in as you select a cluster, creating smaller clusters until you reach the individual markers.

When working with clusters, you can also add buttons to your map to freeze and unfreeze your clusters. 
```{r}
leaflet(birds_joined) %>% addTiles() %>% addMarkers(
  clusterOptions = markerClusterOptions(), #here you being to use the cluster option plug in
    clusterId = "birdsCluster",
  label = ~sci_name) %>% # here you use  formula interface by making the label the scientific name of the bird that was seen.
  addEasyButton(easyButton(  
    states = list(
      easyButtonState( 
        stateName="unfrozen-markers",
        icon="ion-toggle", 
        title="Freeze Clusters",
        onClick = JS(" 
          function(btn, map) {
            var clusterManager =
              map.layerManager.getLayer('cluster', 'birdsCluster');
            clusterManager.freezeAtZoom();
            btn.state('frozen-markers');
          }")
      ),
      easyButtonState( 
        stateName="frozen-markers",
        icon="ion-toggle-filled", 
        title="UnFreeze Clusters",
        onClick = JS(" 
          function(btn, map) {
            var clusterManager =
              map.layerManager.getLayer('cluster', 'birdsCluster');
            clusterManager.unfreeze();
            btn.state('unfrozen-markers');
          }")
      )
    )
  ))
```

